<div 
  class="flex flex-col h-full transition-all duration-500 w-full group/day border-t-[3px]"
  [class.hover:bg-white/5]="!isCurrentDay()"
  [class.border-transparent]="!isCurrentDay()"
  [class.border-planner-today-indicator]="isCurrentDay()"
  [class.bg-planner-today-bg]="isCurrentDay()"
  [class.rounded-t-3xl]="isCurrentDay()"
  role="region"
  (dragover)="$event.preventDefault()"
>
    <!-- Day Header & Capacity -->
    <div class="flex-shrink-0 relative z-10" style="height: 7.5rem;">
      <header class="text-center pt-4 pb-2 flex-shrink-0">
        <h3 class="text-lg tracking-wide" 
            [class.text-white]="isCurrentDay()" 
            [class.font-bold]="isCurrentDay()"
            [class.text-[#666666]]="!isCurrentDay()"
            [class.font-normal]="!isCurrentDay()">
          {{ day() }}
        </h3>
        <div class="text-sm mt-0.5 font-mono"
             [class.text-white]="isCurrentDay()"
             [class.font-bold]="isCurrentDay()"
             [class.text-[#666666]]="!isCurrentDay()"
             [class.font-normal]="!isCurrentDay()">
             {{ taskService.weekDates()[dayIndex()] }}
        </div>
      </header>
      
      <div class="px-4 pb-2 flex-shrink-0">
         <div class="flex items-end justify-between mb-1" [class.invisible]="taskService.dailyLoad()[day()].total === 0">
            <span class="text-sm font-mono"
                  [class.text-white]="isCurrentDay()"
                  [class.font-bold]="isCurrentDay()"
                  [class.text-[#666666]]="!isCurrentDay()"
                  [class.font-normal]="!isCurrentDay()">
                  {{ taskService.dailyLoad()[day()].total }}m
            </span>
            <span class="text-sm font-mono"
                  [class.text-white]="isCurrentDay()"
                  [class.font-bold]="isCurrentDay()"
                  [class.text-[#666666]]="!isCurrentDay()"
                  [class.font-normal]="!isCurrentDay()">
                  {{ taskService.dailyLoad()[day()].percentage | number:'1.0-0' }}%
            </span>
         </div>
        <div class="w-full h-1 bg-planner-surface rounded-full overflow-hidden" [class.invisible]="taskService.dailyLoad()[day()].total === 0">
          <div class="h-full transition-all duration-700 ease-out rounded-full shadow-[0_0_10px_rgba(255,255,255,0.2)]"
            [style.width.%]="taskService.dailyLoad()[day()].percentage"
            [style.background-color]="taskService.dailyLoad()[day()].color">
          </div>
        </div>
      </div>
    </div>

    <!-- Fixed Category Grid (Removed internal scrolling to allow parent grid to scroll) -->
    <div class="flex-grow min-h-0 pb-4 flex flex-col">
      
      @for(cat of categories; track cat; let i = $index) {
        <div 
           class="flex flex-col gap-2 px-2 py-[1.375rem] transition-colors duration-200"
           [class.bg-white/5]="isDropTarget(cat)"
           (dragover)="$event.preventDefault()" 
           (drop)="handleDrop($event, cat)"
           (dragenter)="taskService.onDragEnter({ type: 'day', day: day(), category: cat })"
        >
            <!-- Active Tasks -->
            @for(todo of taskService.week()[day()][cat]; track todo.id) {
               <div 
                [draggable]="taskService.editingTaskId() !== todo.id" 
                (dragstart)="taskService.editingTaskId() !== todo.id && onWeekDragStart($event, todo, cat)" 
                (dblclick)="taskService.editingTaskId() !== todo.id && taskService.startEdit(todo); $event.stopPropagation()"
                class="relative flex items-center bg-planner-surface rounded-md border group-hover:border-planner-border hover:-translate-y-[2px] transition-all duration-200 group flex-shrink-0 min-h-[3.5rem] mt-2 p-3" 
                [class.animate-card-complete]="taskService.justCompletedTaskId() === todo.id"
                [class.border-transparent]="!todo.completed"
                [class.border-done-green]="todo.completed"
                [class.ring-1]="isCurrentDay() && !todo.completed"
                [class.ring-cat-asap]="isCurrentDay() && !todo.completed && cat === 'goal'"
                [class.ring-cat-soon]="isCurrentDay() && !todo.completed && cat === 'focus'"
                [class.ring-cat-pending]="isCurrentDay() && !todo.completed && cat === 'work'"
                [class.ring-cat-leisure]="isCurrentDay() && !todo.completed && cat === 'leisure'"
                [class.ring-cat-basics]="isCurrentDay() && !todo.completed && cat === 'basics'"
                [class.grayscale]="isPast() && !todo.completed"
                [class.opacity-40]="isPast() && !todo.completed"
                [class.opacity-60]="isFutureDay() && !todo.completed"
                [class.hover:opacity-100]="isFutureDay() && !todo.completed"
                [class.hover:saturate-100]="isFutureDay() && !todo.completed"
                [class.shadow-md]="isCurrentDay() && !todo.completed"
                [class.hover:shadow-lg]="isCurrentDay() && !todo.completed"
                [class.shadow-sm]="todo.completed"
                [class.hover:shadow-md]="(isFutureDay() && !todo.completed) || todo.completed"
                role="button">
                
                 @if (!todo.completed && !(isPast() && !todo.completed)) {
                  <div class="absolute left-0 top-0 bottom-0 w-1"
                        [class.bg-cat-asap]="cat === 'goal'"
                        [class.bg-cat-soon]="cat === 'focus'"
                        [class.bg-cat-pending]="cat === 'work'"
                        [class.bg-cat-leisure]="cat === 'leisure'"
                        [class.bg-cat-basics]="cat === 'basics'"></div>
                 }
  
                 @if(taskService.editingTaskId() === todo.id) {
                    <div class="flex items-center gap-1 w-full z-10 pl-2">
                      <input type="text" [(ngModel)]="taskService.editingTaskText" (keydown.enter)="taskService.saveEdit()" (keydown.escape)="taskService.cancelEdit()" class="flex-grow min-w-0 bg-transparent text-sm focus:outline-none border-b border-white/20" autoFocus (dblclick)="$event.stopPropagation()">
                      <input type="number" [(ngModel)]="taskService.editingTaskDuration" (keydown.enter)="taskService.saveEdit()" (keydown.escape)="taskService.cancelEdit()" class="w-8 bg-transparent text-sm text-right focus:outline-none border-b border-white/20 font-mono text-planner-text-dim" placeholder="m">
                    </div>
                 } @else {
                    <div class="flex items-center w-full pl-2 gap-2">
                      <span class="text-[14px] font-bold leading-snug truncate transition-opacity duration-300 flex-grow min-w-0"
                          [class.line-through]="todo.completed"
                          [class.text-white]="!todo.completed"
                          [class.text-done-green]="todo.completed">
                          {{ todo.text }}
                          <span class="font-normal text-xs" [class.text-planner-text-dim]="!todo.completed" [class.text-done-green]="todo.completed">({{ todo.duration }}m)</span>
                      </span>
                      
                      <!-- Checkbox -->
                      <button (click)="taskService.toggleTodoCompletion(day(), cat, todo.id); $event.stopPropagation()" class="w-4 h-4 rounded-sm flex-shrink-0 flex items-center justify-center transition-all duration-300 border"
                         [class.border-white/20]="!todo.completed" 
                         [class.hover:border-done-green]="!todo.completed"
                         [class.border-done-green]="todo.completed"
                         [class.bg-done-green]="todo.completed">
                         <svg class="w-3 h-3 text-planner-bg transition-all duration-300" 
                            [class.scale-0]="!todo.completed" 
                            [class.scale-100]="todo.completed"
                            viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="4" stroke-linecap="round" stroke-linejoin="round">
                            <polyline points="20 6 9 17 4 12"></polyline>
                         </svg>
                      </button>
                    </div>
                 }
              </div>
            }
  
            <!-- Ghost Slots (Updated for progressive disclosure) -->
            @for(slot of getRemainingSlotsForCategory(cat); track $index) {
               <div 
                  (dblclick)="initQuickAdd(cat)"
                  class="h-[3.5rem] border-2 border-dashed border-[var(--ghost-slot-border)] rounded-lg bg-transparent transition-all duration-200 ease-in-out cursor-pointer flex items-center justify-center group/ghost hover:border-[var(--ghost-slot-border-hover)] hover:bg-white/[.02] opacity-15 group-hover/day:opacity-75"
                  title="Double click to add task">
                  <!-- Plus Icon -->
                  <svg xmlns="http://www.w3.org/2000/svg" 
                       class="w-6 h-6 text-transparent transition-all duration-200 ease-in-out group-hover/ghost:text-[var(--ghost-slot-icon)] group-hover/ghost:scale-110"
                       fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2">
                     <path stroke-linecap="round" stroke-linejoin="round" d="M12 4v16m8-8H4" />
                  </svg>
               </div>
            }
        </div>
      }

      <!-- Quick Add Form Overlay -->
      @if(isQuickAddOpen()) {
          <div class="fixed inset-0 bg-black/50 z-50 flex items-center justify-center" (click)="isQuickAddOpen.set(false)">
             <div class="bg-planner-card p-4 rounded-xl shadow-2xl w-96 border border-white/10 animate-pop-in" (click)="$event.stopPropagation()">
                 <h4 class="text-white font-bold mb-2">Quick Add to {{ quickAddCategory() | titlecase }}</h4>
                 <input 
                   type="text" 
                   [(ngModel)]="quickAddText" 
                   (keydown.enter)="submitQuickAdd()" 
                   (keydown.escape)="isQuickAddOpen.set(false)"
                   placeholder="Task name..." 
                   class="w-full bg-planner-bg border border-white/10 rounded-md px-3 py-2 text-sm text-white focus:outline-none focus:border-indigo-500 mb-3"
                   autoFocus
                 />
                 <div class="flex justify-end gap-2">
                    <button (click)="isQuickAddOpen.set(false)" class="px-3 py-1.5 text-xs text-planner-text-dim hover:text-white transition-colors">Cancel</button>
                    <button (click)="submitQuickAdd()" class="px-3 py-1.5 text-xs bg-indigo-600 hover:bg-indigo-500 text-white rounded transition-colors font-medium">Add Task</button>
                 </div>
             </div>
          </div>
      }
    </div>
</div>